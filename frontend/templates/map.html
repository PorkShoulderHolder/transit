<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script   src="https://code.jquery.com/jquery-1.12.4.min.js"   integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="   crossorigin="anonymous"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.css' rel='stylesheet' />
    <script src="static/geoflow/geoflow.js"></script>
    <script src="static/dataclean.js"></script>
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<div id='map'></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoic2Nod2Fua3N0YSIsImEiOiIwTXZySHdVIn0.2RSD-PKkyPIboteVeFcZ2g';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v9',
    center: [-73.97426810851839, 40.69680336061833],
    zoom: 11
});

var radius = 20;

var lastLoop = new Date;
function gameLoop() {
    var thisLoop = new Date;
    var fps = 1000 / (thisLoop - lastLoop);
    lastLoop = thisLoop;
    //console.log(fps);
}
map.on('load', function () {
    // Add a source and layer displaying a point which will be animated in a circle.

    $.get("flowdata", function(d){
        var paths = clean_paths(JSON.parse(d));
        var transit_flows = new FlowSystem(paths);
        function pointOnCircle(angle) {
            transit_flows.update();
            var coordinates = transit_flows.positions;
            return {
                "type": "MultiPoint",
                "coordinates":coordinates
            };
        }
        map.addSource('point', {
            "type": "geojson",
            "data": pointOnCircle(0)
        });

        map.addLayer({
            "id": "point",
            "source": "point",
            "type": "circle",
            "paint": {
                "circle-radius":  {"stops": [[10, 1], [12, 2],  [14, 3], [15, 3], [16, 5], [17, 7], [18, 9]]},
                "circle-color": "#dd7c33",
                "circle-opacity": {"stops": [[10, 0.4], [18, 0.9]]}
            }
        });
        function animateMarker(timestamp) {
            // Update the data to a new position based on the animation timestamp. The
            // divisor in the expression `timestamp / 1000` controls the animation speed.
            fdata = pointOnCircle(timestamp / 1000);
            map.getSource('point').setData(fdata);
            gameLoop();
            // Request the next frame of the animation.
            requestAnimationFrame(animateMarker);
        }
        map.on('zoom', function () {
            transit_flows.speed = (21.0 - map.transform.zoom) * 0.1 - 0.098;
            console.log(transit_flows.speed);
        });
        animateMarker(0);
    });

    // Start the animation.

});
</script>

</body>
</html>